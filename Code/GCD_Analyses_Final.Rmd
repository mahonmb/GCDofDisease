---
title: "A meta-analysis on global change drivers and the risk of infectious disease - Supplemental RMarkdown"
author: "Rohr, J.R., M.B. Mahon, A. Sack, C. Barbera, E. Brown, D.J. Civitello, J.M. Cohen, L. de Wit, M. Forstchen, F.W. Halliday, P. Heffernan, S.A. Knutie, A. Korotasz, J. Larson, S.L. Rumschlag, E. Selland, A. Shepack, N. Vincent, and O.A. Young"
date: "6/6/2023"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Setup R environment

Read in R packages, make a ggplot theme to be used throughout the code and for all figures.

```{r setup, echo = FALSE}
knitr::opts_knit$set(root.dir = "C:/Users/mmahon/OneDrive - Environmental Protection Agency (EPA)/Profile/Documents/Research/GlobalChangeDriver_original")
```

```{r Environment Setup, message = FALSE, warning = FALSE}
library(metafor)
library(MuMIn)
library(tidyverse)
library(multcomp)
library(emmeans)
library(ggeffects)
library(forcats)
library(stringr)
library(clubSandwich)
library(cowplot)

##Make ggplot theme to use throughout
theme_JR <- function (base_size = 12, base_family = "") 
{
    theme(
    panel.background = element_rect(fill=NA),
    panel.grid = element_blank(),
    panel.border = element_rect(color = "black", fill = NA),
    axis.line = element_line(color="black"),
    legend.title = element_text(size=18,color="black"),
    legend.text = element_text(size=16,color="black"),
    legend.key = element_rect(fill=NA,color=NA),
    axis.text = element_text(size=12,color="black"),
    axis.title = element_text(size=16,color="black"),
    strip.background =element_rect(fill=NA, color = "black")
    )
}
```


```{r Read and clean data, echo = FALSE}
##Read in dataset
fulldat2 <- read.csv("./Data/FinalDataWRound2.csv")

```

## Grand Mean effect of GCDs on disease

Analysis of grand mean indicates that overall, global change will increase disease.

```{r, Overall model}
mgrand <- rma.mv(SMDH_yi, SMDH_viC,
             random = list(~1|Citation.number, ~1|ind_id),
             data = fulldat2)
          
mgrandro <- robust(mgrand, cluster=Citation.number, clubSandwich=TRUE)
mgrandro

##I2 (heterogeneity statistic) calculation
W <- diag(1/mgrandro$vi)
X <- mgrandro$X
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
100 * sum(mgrandro$sigma2) / (sum(mgrandro$sigma2) + (mgrandro$k-mgrandro$p)/sum(diag(P)))

##I2 = 0.9988417

##17.77732 is due to between study variation; 82.10685 is due to within study variation
100 * mgrand$sigma2 / (sum(mgrand$sigma2) + (mgrand$k-mgrand$p)/sum(diag(P)))

```

Funnel plot to investigate publication biases in dataset.

```{r Funnel plot, echo = F}

##Funnel plot to show potential for bias and heterogeneity
# overallmodel
# estimate = 0.1078
# se = 0.0336

#GCD specific effects
estimate = c(0.7644, 0.3616, 0.1552, -0.1975, 0.4645)
se = c(0.1376, 0.0828, 0.0760, 0.0385, 0.1143)

Maxobsse = sqrt(max(fulldat2$SMDH_viC, na.rm = T))+1

#Compute vectors of the lower-limit and upper limit values for
#the 95% CI region
ll95 = estimate-(1.96*Maxobsse)
ul95 = estimate+(1.96*Maxobsse)

#Put all calculated values into one data frame
#You might get a warning about '...row names were found from a short variable...' 
#You can ignore it.
dfCI = data.frame(x = c(ll95, ul95, estimate),
                  y = c(rep(Maxobsse, times = 10), rep(0,time = 5)),
                  Global.Change.Driver2 = rep(c("BC", "CC","CP", "HLC", "IS"), times = 3))
dfCI$Global.Change.Driver2 = factor(dfCI$Global.Change.Driver2)
dfCI$Global.Change.Driver2 = factor(dfCI$Global.Change.Driver2,
                        levels(dfCI$Global.Change.Driver2)[c(1,3,2,4,5)])

dfEST = data.frame(Maxobsse = Maxobsse,
                   estimate = estimate,
                   Global.Change.Driver2 = c("BC", "CC","CP", "HLC", "IS"))
dfEST$Global.Change.Driver2 = factor(dfEST$Global.Change.Driver2)
dfEST$Global.Change.Driver2 = factor(dfEST$Global.Change.Driver2,
                        levels(dfEST$Global.Change.Driver2)[c(1,3,2,4,5)])


GCD <- c(
  BC = "Biodiversity Change",
  CP = "Chemical Pollution",
  CC = "Climate Change",
  HLC = "Habitat Loss or Change",
  IS = "Introduced Species"
  )

fulldat2$Global.Change.Driver2 = factor(fulldat2$Global.Change.Driver)
fulldat2$Global.Change.Driver2 = factor(fulldat2$Global.Change.Driver2,
                        levels(fulldat2$Global.Change.Driver2)[c(1,3,2,4,5)])

EDF5B <- ggplot(fulldat2, aes(x = SMDH_yi, y = sqrt(SMDH_viC)))+
  facet_grid(~Global.Change.Driver2, labeller = labeller(Global.Change.Driver2 = GCD))+
  scale_y_reverse()+
  geom_polygon(data = dfCI, aes(x = x, y = y),
               fill = "white", color = "black", size = 1,
               linetype = "dashed")+
  geom_segment(data = dfEST, aes(x = estimate, y = 0, xend = estimate, yend = Maxobsse),
               size = 1, linetype = "dashed")+
  # geom_point()+
  geom_point(aes(color = Global.Change.Driver2))+
    scale_color_manual(values = c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2"))+
  coord_cartesian(ylim = c(Maxobsse-1,0))+
  ylab("Standard Error")+
  xlab("Hedge's G")+
  theme_JR()+
  theme(legend.position = "none")
EDF5B

ggsave("./Figures/FunnelPlotGCD.tiff",
       dpi = 300,
       width = 6,
       height = 4.75,
       units = "in")

```

Conduct an Egger's test to test for asymmetry in funnels plot. It can identify small-study effects, but not tell directly whether publication bias exists. To evaluate the funnel asymmetry, we inspect the size of the intercept when the response is the effect size predictor is either SE or variance (meta-regression, so weighted by inverse of SE), and if it differs significantly from zero. When this is the case, Egger's test indicates funnel plot asymmetry.  Variance (beta1) is significant for BC, CC, and IS; intercept (beta0) is significantly different from zero for BC CC HLC and IS. For BC CC and IS, funnel asymmetry is present (with BC being most severe), but no funnel asymmetry for CP and HLC. For BC CC and IS, the significant intercept provides an adjusted estimate that is downwardly biased, while for HLC, the intercept provides the bst estimate for an adjusted mean.

```{r Eggers Test}

###Generate effective sample  size; if no sample size for control and treatment exist, assume equal sample size and multiply 1/sample_size by 4 (is equal to 1/n1 + 1/n2, when n1 = n2)

fulldat2$Sample_size = ifelse(is.na(fulldat2$Sample_size),
                              rowSums(fulldat2[,c("SampleSizeTreatment",
                                                  "SampleSizeControl")],
                                      na.rm = T),
                             fulldat2$Sample_size)

fulldat21 <- fulldat2 %>%
  mutate(Sample_sizeEff = ifelse(SampleSizeControl == 0 | is.na(SampleSizeControl),
                                 (1 / Sample_size) * 4,
                                 (1 / SampleSizeControl) + (1/ SampleSizeTreatment)),
         Sample_sizeEff = ifelse(is.infinite(Sample_sizeEff),
                                 NA,
                                 Sample_sizeEff),
         Sample_sizeEffsqrt = sqrt(Sample_sizeEff),
         Year.c = as.vector(scale(Year, scale = F))
         )




###Publication bias analysis

##Egger's test

mpbias2n <- rma.mv(SMDH_yi, SMDH_viC, mods = ~ Sample_sizeEffsqrt * Global.Change.Driver + Year.c - 1,
                 random = list(~1|Citation.number, ~1|ind_id),
                 data = fulldat21)
          
mpbias2nro <- robust(mpbias2n, cluster=Citation.number, clubSandwich=TRUE)
mpbias2nro

##note that, per Nakagawa 2022, if slope of sqrt(effective sample size) is significant,
##use effective sample size (it is significant, so use model below)

mpbias2n1 <- rma.mv(SMDH_yi, SMDH_viC, mods = ~ Sample_sizeEff * Global.Change.Driver + Year.c - 1,
                 random = list(~1|Citation.number, ~1|ind_id),
                 data = fulldat21)
          

mpbias2nro1 <- robust(mpbias2n1, cluster=Citation.number, clubSandwich=TRUE)
mpbias2nro1
##time is non-significant

mpbias2nem1 <- qdrg(object = mpbias2nro1, data = fulldat21, at = list(Sample_sizeEff = 0, Year.c = 0 ))

##Significant beta0 for BC (+), CC (+), HLC (-)
emmmn <- emmeans(mpbias2nem1,  ~ Global.Change.Driver, nesting = NULL)
test(emmmn)

#Sample_sizeEff
##Significant positive beta1 for BC only
mx <- mean(fulldat21$Sample_sizeEff, na.rm = T)
rg <- qdrg(object = mpbias2nro1, data = fulldat21, nesting = NULL, at = list(Sample_sizeEff = mx + c(0, 1)))
emt <- update(contrast(rg, "consec", simple = "Sample_sizeEff"), by = NULL)
emt

#Plot
#Get trend slines from Egger's test and time regression 
eggerstestlines <- data.frame(Global.Change.Driver2 = factor(unique(fulldat2$Global.Change.Driver)),
           intercept = summary(emmmn)$emmean[c(4,5,2,3,1)],
           slope = summary(emt)$estimate[c(4,5,2,3,1)])

eggerstestlines$Global.Change.Driver = factor(eggerstestlines$Global.Change.Driver,
                                              levels = levels(eggerstestlines$Global.Change.Driver)[c(1,3,2,4,5)])

EDF5C <- ggplot(fulldat21, aes(y = SMDH_yi, x = Sample_sizeEff))+
  facet_grid(~Global.Change.Driver2, labeller = labeller(Global.Change.Driver2 = GCD))+
  geom_hline(yintercept = 0, linetype = "dashed")+
  geom_point(aes(color = Global.Change.Driver2))+
  scale_color_manual(values = c("#5E976E",
                                         "#58355E",
                                         "#FFCA3A",
                                         "#EC0B43",
                                         "#63ADF2")) +
  geom_segment(data = eggerstestlines, aes(x = 0, xend = 2, y = intercept, yend = intercept + slope*10),
               size = 1, color = "black") +
  ylab("Hedge's G")+
  xlab("Inverse of Effective Sample Size")+
  theme_JR()+
  theme(legend.position = "none")

EDF5C

ggsave("./Figures/EggersTestGCD.tiff",
       dpi = 300,
       width = 6,
       height = 4.75,
       units = "in")


```

Conduct Fail-safe N analyses for each global change driver, which will return the "File Drawer Number", which represents the number of statistically non-significant unpublished results needed to exist to make the overall effect non-significant. Repeat analysis for each of the three equations (Rosenthal, Orwin, Rosenberg). Note: setting "target" for Orwin's method equal to 0.1 for all global change drivers. Additionally, Chemical Pollution is already non-significant, so results for CP are inconsequential and will not be discussed here. 

For BC, CC, and IS, all fail-safe N values are above the Threshold for large amount of studies (5*Nstudies + 10). For HLC, the Orwin method was below the threshold value; however, Rosenthal and Rosenberg are 3 and 4 orders of magnitude greater than the threshold value, respectively. For CP, the Orwin method was below the threshold value, but Rosenthal and Rosenberg values were >7x larger than the threshold valus. So, for all GCD, this evidence indicates that the analyses may be robust with respect to publication bias as such a large number of statistically non-significant results is unlikely to exist. 

```{r Fail-safe N}

subdat <- fulldat2 %>%
  filter(!is.na(SMDH_yi),
         !is.na(SMDH_viC))
subdat <- split(subdat, subdat$Global.Change.Driver)

hldn <- data.frame(GCD = as.character(paste(rep(0,times = 5))),
                  Rosenthal = rep(0,times = 5),
                  Orwin = rep(0,times = 5),
                  Rosenberg = rep(0,times = 5),
                  ThreasholdLargeStudyN = rep(0,times = 5))


for(i in 1:length(subdat)){
  hldn$GCD[i] = names(subdat)[i]
  hldn$Rosenthal[i] = fsn(yi = subdat[[i]]$SMDH_yi,
                         vi = subdat[[i]]$SMDH_viC,
                         type = "Rosenthal")$fsnum
  hldn$Orwin[i] = fsn(yi = subdat[[i]]$SMDH_yi,
                     vi = subdat[[i]]$SMDH_viC,
                     type = "Orwin",
                     target = 0.1)$fsnum
  hldn$Rosenberg[i] = fsn(yi = subdat[[i]]$SMDH_yi,
                         vi = subdat[[i]]$SMDH_viC,
                         type = "Rosenberg")$fsnum
  hldn$ThreasholdLargeStudyN[i] = 5*length(unique(subdat[[i]]$Citation.number)) + 10
}

hldn
```



Leave one out analysis to test for robustness of our analyses. For loop is not run due to time constraints, but code is presented. Leave one out analyses suggests that our results are robust to removal of individual studies.

```{r}
# 
# subdat = subgranmod = NULL
# hld = data.frame(beta = 0,
#                  se = 0)

# for(i in 1:length(unique(fulldat2$Citation.number))) {
#   subdat = subgranmod = NULL
#   subdat <- fulldat2 %>%
#     filter(Citation.number != unique(fulldat2$Citation.number)[i])
#   subgranmod <- rma.mv(SMDH_yi, SMDH_viC,
#                        random = list(~1|Citation.number, ~1|ind_id),
#                        data = subdat)
#   hld[i,1] = subgranmod$beta[1]
#   hld[i,2] = subgranmod$se
# }
# saveRDS(hld, "G:/Shared drives/GCD of Disease/Final_dat/Leave1Outdat.RDS")

hld <- readRDS("./Data/Leave1OutdatNEW.RDS")

l1o <- ggplot(hld, aes(x = 1:nrow(hld), y = beta))+
  geom_errorbar(aes(ymin = beta - se, ymax = beta + se), width = 0)+
  geom_point(color = "light grey", size = 2)+
  geom_hline(yintercept = 0.1010, color = "#EA2B1F", linewidth = 1)+
  geom_hline(yintercept = 0.1010 + 0.0338, color = "#EA2B1F", linewidth = 1)+
  geom_hline(yintercept = 0.1010 - 0.0338, color = "#EA2B1F", linewidth = 1)+
  scale_x_continuous(limits = c(0,580), expand = c(0,0))+
  labs(x = "Study",
       y = "Hedge's G")+
  theme_JR()+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
l1o
ggsave("./Figures/Leave1out.tiff",
       dpi = 300,
       width = 5,
       height = 4.65,
       units = "in")


```

Forest plots to show distribution of effect sizes and variances among global change drivers.

```{r, echo = FALSE}

data2 = fulldat2 %>%
  filter(! is.na(SMDH_yi)) %>%
  filter(! is.na(SMDH_viC))

##Weights as percentages
data2$weights = rowSums(weights(mgrandro, type = "matrix"))/100
data2 = data2[order(data2$SMDH_yi),]

data2$x = seq(1,nrow(data2)*2,2)
set.seed(20)
data2$x2 = sample(data2$x, nrow(data2))

data2$Global.Change.Driver = as.factor(data2$Global.Change.Driver)
data2$Global.Change.Driver = factor(data2$Global.Change.Driver,
                        levels(data2$Global.Change.Driver)[c(1,3,2,4,5)])

EDF5A <- ggplot(data2, aes(y = SMDH_yi, x = x2, color = Global.Change.Driver))+
  # scale_y_continuous(limits = c(-7.5,7.5),
  #                    expand = c(0,0))+
  facet_grid(~Global.Change.Driver, labeller = labeller(Global.Change.Driver = GCD))+
  scale_x_reverse()+
  geom_hline(yintercept = 0, linetype = "dashed")+
  geom_errorbar(aes(x = x2,
                    ymax = SMDH_yi + sqrt(SMDH_viC),
                    ymin = SMDH_yi - sqrt(SMDH_viC)),
                width = 0)+
  geom_point(aes(size = weights), shape = 21)+
  # geom_errorbar(aes(x = max(x), y = 0.1875,
  #                   ymin = 0.095,
  #                   ymax = 0.28), width = 10)+
  # geom_point(aes(x = max(x), y = 0.1875), shape = 23, fill = NA, size = 4)+
  scale_color_manual(values = c("#5E976E",
                                         "#58355E",
                                         "#FFCA3A",
                                         "#EC0B43",
                                         "#63ADF2")) +
  # coord_flip(ylim = c(-10,10))+
  ylab("Hedge's G")+
  coord_flip()+
  theme_JR()+
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank(),
        legend.position = "none")
EDF5A
ggsave("./Figures/ForestPlot.tiff",
       dpi = 300,
       height = 5.5,
       width = 7.5,
       units = "in")

```

```{r, echo = FALSE, eval = FALSE}
#Generate Extended data figure 5
EDF5_WHOLE = cowplot::align_plots(EDF5A,
                                  EDF5B,
                                  EDF5C,
                                  l1o,
                                  align = 'hv', axis = 'l')


EDF5_fig = cowplot::plot_grid(EDF5_WHOLE[[1]], 
                                 EDF5_WHOLE[[2]], 
                                 EDF5_WHOLE[[3]],
                              EDF5_WHOLE[[4]],
                             labels = c("A)","B)","C)","D)"),
                             ncol = 1,
                             label_x = 0,
                             label_y = 0.975)
EDF5_fig
ggsave("./Figures/EDF5.tiff",
       dpi = 300,
       height = 11.3,
       width = 12,
       units = "in")

```

# Analyses

## Step 1: Test for effects of Global Change Drivers (GCDs)

Generally, we find that biodiversity change, introduced species, and climate change significantly increase disease. Habitat loss/change significantly decreases disease. Chemical pollution showed a non-significant effect on disease. 

```{r General Effects of GCDs, warning = FALSE}
options(contrasts = c("contr.treatment","contr.poly"))

m2 <- rma.mv(SMDH_yi, SMDH_viC,
             mods = ~  Global.Change.Driver - 1,
             random = list(~1|Citation.number, ~1|ind_id),
             data = fulldat2)
          
m2ro <- robust(m2, cluster=Citation.number, clubSandwich=TRUE)
m2ro

##I2 (heterogeneity statistic) calculation
W <- diag(1/m2ro$vi)
X <- m2ro$X
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
100 * sum(m2ro$sigma2) / (sum(m2ro$sigma2) + (m2ro$k-m2ro$p)/sum(diag(P)))

##I2 = 99.87

##12.10 is due to between study variation; 87.77 is due to within study variation
100 * m2ro$sigma2 / (sum(m2ro$sigma2) + (m2ro$k-m2ro$p)/sum(diag(P)))

##Set up emmeans reference grid
m2g <- qdrg(object = m2ro, data = fulldat2)


m2em <- emmeans(m2g, ~ Global.Change.Driver)
emmeans:::cld.emmGrid(m2em)

```

```{r Figure for Main GCDs, echo = FALSE}

figdat_GCD <- data.frame(m2em)
figdat_GCD$grouping = c("*A", "*AB", "*B", "*C", "*AB")
figdat_GCD$EffLab = c(5,3,4,2,1)

#create a new column for GCD labels used in figure 
figdat_GCD$Global.Change.Driver2 <- c("Biodiversity Change", 
                                      "Climate Change", 
                                      "Chemical Pollution", 
                                      "Habitat Loss or Change",
                                      "Introduced Species")


figdat_GCD$k = (fulldat2 %>%
  group_by(Global.Change.Driver) %>%
  summarize(count = n()))$count

figdat_GCD$n = (fulldat2 %>%
  group_by(Global.Change.Driver) %>%
  summarize(count = length(unique(Citation.number))))$count


figdat_GCD$GCD_xlab <- paste(figdat_GCD$Global.Change.Driver2, "\n(n = ", 
                             figdat_GCD$n, ", k = ",
                             figdat_GCD$k, ")", sep = "")

#make the plot
ggplot(figdat_GCD, aes(x = GCD_xlab, 
                       y = emmean,
                       color = Global.Change.Driver2)) +
    geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             linewidth = 1) +
  geom_point(size = 3) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                size = 1) +                   #adjust width of bar
  geom_text(aes(label = grouping,
                x = EffLab),
            color = "black",
            position = position_nudge(x = 0.25))+
  scale_y_continuous(limits = c(-0.275,1.05),      #change limits of Y axis
                     breaks = seq(-0.25,1,0.25))+      #set Y axis breaks
  scale_color_manual(values = c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2"))+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  scale_x_discrete(limits = rev(levels(as.factor(figdat_GCD$GCD_xlab))))+
  coord_flip()+
  theme_JR()+                                   #call your theme
  theme(legend.position = "none",
        axis.title.y = element_blank())

ggsave("./Figures/GCDMetaFig2.tiff",
       dpi = 300,
       width = 4.85,
       height = 3.5,
       units = "in")

```



## Step 2: Test for Subfactors: i.e., subgroupings of ALL GCDs
### Information on Step 2
- In Introduced Species:
  - Spillover/Spillback is own subfactor; reclassified as 
    - Alien:native/native:alien

We see that only a small handful of subfactors actually significantly affect disease
- Biodiversity loss, mean temperature, CO~2~, and enemy release increase disease
- Urbanization reduces disease
- Fungicides marginally increase disease (p = 0.0676)
- All other subfactors have non-significant effects on disease


```{r Subfactor analyses}

mGCDriver_sub <- rma.mv(SMDH_yi, SMDH_viC,
             mods = ~  Effect - 1,
             random = list(~1|Citation.number, ~1|ind_id),
             data = fulldat2)
             
mGCDriver_subro <- robust(mGCDriver_sub, cluster=Citation.number, clubSandwich=TRUE)
mGCDriver_subro

##I2 (heterogeneity statistic) calculation
W <- diag(1/mGCDriver_subro$vi)
X <- mGCDriver_subro$X
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
100 * sum(mGCDriver_subro$sigma2) / (sum(mGCDriver_subro$sigma2) + (mGCDriver_subro$k-mGCDriver_subro$p)/sum(diag(P)))

##I2 = 99.86

##10.60 is due to between study variation; 89.26 is due to within study variation
100 * mGCDriver_subro$sigma2 / (sum(mGCDriver_subro$sigma2) + (mGCDriver_subro$k-mGCDriver_subro$p)/sum(diag(P)))


##Set up emmeans reference grid
mGCDriver_subrog <- qdrg(object = mGCDriver_subro, data = fulldat2)


mGCDriver_subroem <- emmeans(mGCDriver_subrog, ~ Effect)
emmeans:::cld.emmGrid(mGCDriver_subroem)

```

```{r Subfactor figure, echo = FALSE, warning = FALSE}
figdat_sub <- data.frame(est = mGCDriver_subro$beta,
                         ci.low = mGCDriver_subro$ci.lb,
                         ci.up = mGCDriver_subro$ci.ub,
                         GCD = row.names(mGCDriver_subro$beta))

figdat_sub$Effect = as.factor(gsub('Effect', '', figdat_sub$GCD))

figdat_sub$GCD = fct_rev(fulldat2$Global.Change.Driver[match(figdat_sub$Effect,
                                                              fulldat2$Effect)])

# 
figdat_sub$GCD = fct_rev(figdat_sub$GCD)

figdat_sub$Effect <- str_to_sentence(figdat_sub$Effect)

figdat_sub$Effect[5] = "CO2"
figdat_sub$Effect[4] = "Climate variability or ENSO"
figdat_sub$Effect[21] = "UVB"

figdat_sub$Effect = as.factor(figdat_sub$Effect)

subkn = (fulldat2 %>%
  group_by(Effect) %>%
  summarize(kcount = n(),
            ncount = length(unique(Citation.number))))


figdat_sub$n = subkn$ncount[c(1,2,4,5,3,6:19,21,20)]
figdat_sub$k = subkn$kcount[c(1,2,4,5,3,6:19,21,20)]

figdat_sub$GCD_xlab <- as.factor(paste(figdat_sub$Effect, "\n(n = ", 
                             figdat_sub$n, ", k = ",
                             figdat_sub$k, ")", sep = ""))
# 


figdat_sub$GCD_xlab = factor(figdat_sub$GCD_xlab,
                                          levels(figdat_sub$GCD_xlab)[c(1,2,
                                                                        5,8,10:12,16,18,19,21,
                                                                        3,4,14,15,
                                                                        6, 9,20,
                                                                        7,13,17)])


# figdat_sub$GCD = factor(figdat_sub$GCD,
#                         levels(figdat_sub$GCD)[c(5,3,4,2,1)])


#make the plot
ggplot(figdat_sub, aes(x = GCD_xlab, 
                       y=est,
                       color = GCD)) +            
    geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  geom_vline(xintercept = c(3.5,6.5,10.5,19.5),
             color = "grey",
             linetype = "dotted",
             linewidth = 1)+
  geom_point(size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = ci.low,        #include error bars
                    ymax = ci.up),     
                width=0.33,
                linewidth = 0.6) +                   #adjust width of bar
  scale_y_continuous(limits = c(-7.02,9),      #change limits of Y axis
                     breaks = seq(-6,8,2))+      #set Y axis breaks
  xlab("") +               #relabel X and Y axes
  ylab("Hedge's G") +
  scale_color_manual(values = c("#5E976E",
                                "#FFCA3A",
                                "#58355E",
                                "#EC0B43",
                                "#63ADF2"))+
  coord_flip()+#ylim = c(-2,2))+
  scale_x_discrete(limits = rev(levels(figdat_sub$GCD_xlab)))+
  theme_JR()+                                   #call your theme
  theme(legend.position = "none",
        axis.text.y = element_text(size = 9),
        axis.title.y = element_blank())

ggsave("./Figures/GCDFig3NEWwhole.tiff",
       dpi = 300,
       width = 6,
       height = 7,
       units = "in")

```


## Step 3: Test for Interactions between GCDs and other factors:
### Checking for generalities of the patterns
Checking for main and interactive effects between study, host, and parasite factors and the main global change drivers.


```{r Interaction Models - Generality of Findings Setup, echo = FALSE}

#Regression models that include two-way interactions between GC Drivers and each other factor
#Returns to deviations from a reference level
options(contrasts = c("contr.treatment","contr.poly"))


##Continent
#
contdat <- fulldat2 %>%
  filter(!is.na(ContinentUse)) %>%
  filter(!(ContinentUse == "Australia" & Global.Change.Driver == "CP")) %>%
  filter(!(ContinentUse == "South America" & Global.Change.Driver == "CP"))

##Host Type
#<3 replicates for Coral, Fish, and Mollusks in at least one GCDriver category
dathost = fulldat2 %>%
  filter(!is.na(Native.host.type)) %>%
  filter(!(Native.host.type %in% c("Fish", "Echinoderm", "Coral")))

##Parasite type
#<3 replicates for Myxozoan and Rotifer in at least one GCDriver category
datenemy = fulldat2 %>%
  filter(!is.na(Enemy.type)) %>%
  filter(!(Enemy.type %in% c("Myxozoan", "Rotifer")))


##Vectors - Yes/No
#<2 replicates in the Biodiversity and Chemical Contaminant categories
vecdat <- fulldat2 %>%
  filter(!is.na(Vector)) %>%
  filter(!(Global.Change.Driver %in% c("BC", "CP")))



##Vector-borne
vecbordat = fulldat2[!is.na(fulldat2$Vector.borne),]



##Ectoparasites; drop NAs
ectodat = fulldat2[!is.na(fulldat2$Ectoparasite),]




##Human parasites; drop NAs
humdat = fulldat2[!is.na(fulldat2$Human.Parasite),]

##Venue
vendat = fulldat2 %>%
  filter(!is.na(Venue))


###Habitat; drop NAs
habdat = fulldat2[ complete.cases(fulldat2$Habitat), ]

###Route; drop NAs
datRoute = subset(fulldat2, !is.na(Route))

###Free Living Stages; drop NAs
datFLstage = subset(fulldat2, !is.na(Free.living.stages))

###Endpoint: host/parasite; drop NAs
datEndpoint = subset(fulldat2, !is.na(Endpoint_Host_Parasite))

###Macroparasite: Y/N; drop NAs
datMacroparasite = subset(fulldat2, !is.na(Macroparasite))

###Thermy of host
datHostThermy = subset(fulldat2, !is.na(Ectothermic.host))

###Zoonotic diseases; drop NAs
datZoonotic = fulldat2 %>%
  filter(!is.na(Zoonotic)) 

```

## Continent


```{r}

##Number of replicates
nrow(contdat)

##Main effect of endpoint
mContinent <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ ContinentUse + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=contdat, method = "ML")
        
mContinentIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ ContinentUse * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=contdat, method = "ML")
        

##different; interaction is significant
anova(mContinent, mContinentIntML)


mContinentInt <- rma.mv(SMDH_yi, SMDH_viC,
       mods = ~ ContinentUse * Global.Change.Driver - 1,
       random = list(~1|Citation.number, ~1|ind_id),
       data=contdat)
        
mContinentIntro <- robust(mContinentInt, cluster=Citation.number, clubSandwich=TRUE)
mContinentIntro

##Currently, testing whether the effect of GCDs are similar across endpoints
##Set up emmeans reference grid
mContg <- qdrg(object = mContinentIntro, data = contdat)

mContgem <- emmeans(mContg, ~ ContinentUse|Global.Change.Driver)


##Differences between Europe and North America for HLC
##Differences between Europe and Asia for BC
pairs( (mContgem))

```

```{r}
##Data
datfigCont <- data.frame(mContgem)
datfigCont$Global.Change.Driver = as.factor(datfigCont$Global.Change.Driver)
datfigCont$Global.Change.Driver = factor(datfigCont$Global.Change.Driver,
                        levels(datfigCont$Global.Change.Driver)[c(1,3,2,4,5)])

figCont <- ggplot(datfigCont, aes(x = ContinentUse, 
                 y=emmean,
                 color = ContinentUse)) +            #subtract 2 to adjust range of response
  facet_grid(~Global.Change.Driver, labeller = labeller(Global.Change.Driver = GCD)) + 
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  xlab("Continent") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()  +
  theme(legend.position = "none")

figCont

ggsave("./Figures/GCDFigSContinent.tiff",
       dpi = 300,
       width = 6.5,
       height = 4.65,
       units = "in")


```


### Host/Parasite Endpoint
There are differences between host and parasite endpoints in response to  biodiversity change and introduced species. Habitat loss, climate change, and chemical pollution indicate no differences in response according to host/parasite endpoint. For BC and IS, parasite endpoints increase more in response to GCD than host endpoints. 

```{r Endpoint}

##Number of replicates
nrow(fulldat2)

##Main effect of endpoint
mEndpoint <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Endpoint_Host_Parasite + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=fulldat2, method = "ML")
        
mEndpointIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Endpoint_Host_Parasite * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=fulldat2, method = "ML")
        

##different; interaction is significant
anova(mEndpoint, mEndpointIntML)


mEndpointInt <- rma.mv(SMDH_yi, SMDH_viC,
       mods = ~ Endpoint_Host_Parasite * Global.Change.Driver - 1,
       random = list(~1|Citation.number, ~1|ind_id),
       data=fulldat2)
        


mEndpointIntro <- robust(mEndpointInt, cluster=Citation.number, clubSandwich=TRUE)
mEndpointIntro


##Currently, testing whether the effect of GCDs are similar across endpoints
##Set up emmeans reference grid
mEndg <- qdrg(object = mEndpointIntro, data = fulldat2)

mEndgem <- emmeans(mEndg, ~ Endpoint_Host_Parasite|Global.Change.Driver)


##Host and parasite are different in BC only
pairs(mEndgem)
```

```{r Endpoint figure, echo = FALSE}
##Data
dat1 <- data.frame(mEndgem)
dat1$Global.Change.Driver <- as.factor(dat1$Global.Change.Driver)

dat1$Global.Change.Driver <- factor(dat1$Global.Change.Driver,
                                          levels(dat1$Global.Change.Driver)[c(5,4,2,3,1)])

#make the plot
endpointfig <- ggplot(dat1, aes(x = Global.Change.Driver, 
                 y = emmean,
                 shape = Endpoint_Host_Parasite,
                 color = Global.Change.Driver)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  scale_color_manual(values = rev(c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2")),
                     name = "Global Change Driver",
                     guide = "none")+
  scale_shape_manual(values = c(16,17),
                     name = "Endpoint")+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()     

endpointfig
# ggsave("./Figures/GCDFigS12.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")
```


### Host Taxon
Model indicates a significant interaction, but post host test indicates that within BC, Mammals and Mollusk are different; within HLC, mollusks are different from Arthropods and Mammals. No other differences among host taxa within global change drivers.

```{r Taxon}

##Number of replicates
nrow(dathost)

mHost_Taxon <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Native.host.type + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=dathost, method = "ML")
                  
        

mHost_TaxonIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Native.host.type * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=dathost, method = "ML")
        

##different
anova(mHost_Taxon, mHost_TaxonIntML)


mHost_TaxonInt <- rma.mv(SMDH_yi, SMDH_viC,
       mods = ~ Native.host.type * Global.Change.Driver - 1,
       random = list(~1|Citation.number, ~1|ind_id),
       data=dathost)


mHost_TaxonIntro <- robust(mHost_TaxonInt, cluster=Citation.number, clubSandwich=TRUE)
mHost_TaxonIntro

##Currently, testing whether the effect of GCDs are similar across endpoints
##Set up emmeans reference grid
mHost_Taxong <- qdrg(object = mHost_TaxonIntro, data = dathost)

mHost_Taxongem <- emmeans(mHost_Taxong, ~ Native.host.type|Global.Change.Driver)

##Only different in CC
pairs(mHost_Taxongem)

```

```{r Host Taxon Figure, echo = FALSE}

datfig_Host <- data.frame(mHost_Taxongem)
datfig_Host$Global.Change.Driver = as.factor(datfig_Host$Global.Change.Driver)
datfig_Host$Global.Change.Driver = factor(datfig_Host$Global.Change.Driver,
                        levels(datfig_Host$Global.Change.Driver)[c(1,3,2,4,5)])
#make the plot
hostfig <- ggplot(datfig_Host, aes(x = Native.host.type, 
                 y=emmean,
                 color = Native.host.type)) +            #subtract 2 to adjust range of response
  facet_grid(~Global.Change.Driver, labeller = labeller(Global.Change.Driver = GCD)) + 
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  xlab("Host Taxon") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()  +
  theme(legend.position = "none")

hostfig
ggsave("./Figures/GCDFigSHTax.tiff",
       dpi = 300,
       width = 6.5,
       height = 4.65,
       units = "in")

```

### Parasite Taxon
Some differences among parasite taxon. Interaction model suggests only differences in responses among taxa are within biodiversity change, introduced species, and Habitat loss and change
- Helminths respond more positively than bacteria and viruses to biodiversity change
- Fungi respond more positively than viruses and helminths to introduced species
- Viruses respond less negatively than helminths to habitat loss/change

```{r}
##Number of replicates
nrow(datenemy)


mEnemy_Taxon <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Enemy.type + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datenemy, method = "ML")
        
mEnemy_TaxonIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Enemy.type * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datenemy, method = "ML")
        
                

##very different
anova(mEnemy_Taxon, mEnemy_TaxonIntML)

mEnemy_TaxonInt <- rma.mv(SMDH_yi, SMDH_viC,
                      mods = ~ Enemy.type * Global.Change.Driver - 1,
                      random = list(~1|Citation.number, ~1|ind_id),
                      method = "REML", data=datenemy)
        


mEnemy_TaxonIntro <- robust(mEnemy_TaxonInt, cluster=Citation.number, clubSandwich=TRUE)
mEnemy_TaxonIntro

##Set up emmeans reference grid
mEnemyg <- qdrg(object = mEnemy_TaxonIntro, data = datenemy)

mEnemygem <- emmeans(mEnemyg, ~ Enemy.type|Global.Change.Driver)

#
pairs((mEnemygem))

```

```{r Parasite figure, echo = FALSE}

datfig_Enemy <- data.frame(mEnemygem)
datfig_Enemy$Global.Change.Driver = as.factor(datfig_Enemy$Global.Change.Driver)
datfig_Enemy$Global.Change.Driver = factor(datfig_Enemy$Global.Change.Driver,
                        levels(datfig_Enemy$Global.Change.Driver)[c(1,3,2,4,5)])
#make the plot
enemyfig <- ggplot(datfig_Enemy, aes(x = Enemy.type, 
                 y=emmean,
                 color = Enemy.type)) +            #subtract 2 to adjust range of response
  facet_grid(~Global.Change.Driver, labeller = labeller(Global.Change.Driver = GCD)) + 
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  xlab("Enemy Taxon") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()  +
  theme(legend.position = "none")
enemyfig

ggsave("./Figures/GCDFigS6.tiff",
       dpi = 300,
       width = 6.5,
       height = 4.65,
       units = "in")
```

```{r, echo = FALSE, eval = FALSE}
#Generate Extended data figure 8
EDF8_WHOLE = cowplot::align_plots(figCont,
                                  hostfig,
                                  enemyfig, 
                                  align = 'hv', axis = 'l')
EDF8_fig = cowplot::plot_grid(EDF8_WHOLE[[1]], 
                                 EDF8_WHOLE[[2]], 
                                 EDF8_WHOLE[[3]],
                             labels = c("A)","B)","C)"),
                             ncol = 1,
                             label_x = 0,
                             label_y = 0.975)
EDF8_fig
ggsave("./Figures/EDF8.tiff",
       dpi = 300,
       height = 8.5,
       width = 12,
       units = "in")

```


### Vector 
No difference between vectors and non-vectors
```{r Vector}
##Number of replicates
nrow(vecdat)

mVector <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Vector + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=vecdat, method = "ML")
        
mVectorInt <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Vector * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=vecdat, method = "ML")
        
## different
anova(mVector, mVectorInt)


mVectorInt <- rma.mv(SMDH_yi, SMDH_viC,
                      mods = ~ Vector + Global.Change.Driver - 1,
                      random = list(~1|Citation.number, ~1|ind_id), data=vecdat)
        


mVectorIntro <- robust(mVectorInt, cluster=Citation.number, clubSandwich=TRUE)
mVectorIntro

##Set up emmeans reference grid
mVectorg <- qdrg(object = mVectorIntro, data = vecdat)

mVectorgem <- emmeans(mVectorg, ~ Vector)

#
pairs((mVectorgem))


```


### Vector-borne
No generalizable differences between vector-borne and non-vector-borne diseases, but within biodiversity change and Introduced Species, there are differences. In biodiversity change, vector-borne diseases respond significantly stronger (positive) to biodiversity change than non-vector-borne diseases. This is consistent with previous work from Dave Civitello, suggesting that dilution effect is more prominent in vector-borne diseases. In Introduced Species, non-vector-borne diseases respond significantly stronger (positive) to introduced species than vector-borne diseases.

```{r Vector-borne}
##Number of replicates
nrow(vecbordat)

mVectorBorne <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Vector.borne + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=vecbordat, method = "ML")
        
mVectorBorneIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Vector.borne * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=vecbordat, method = "ML")
        

anova(mVectorBorne, mVectorBorneIntML)


mVectorBorneInt <- rma.mv(SMDH_yi, SMDH_viC,
                      mods = ~ Vector.borne * Global.Change.Driver - 1,
                      random = list(~1|Citation.number, ~1|ind_id), data=vecbordat)
        


mVectorBorneIntro <- robust(mVectorBorneInt, cluster=Citation.number, clubSandwich=TRUE)
mVectorBorneIntro


##Set up emmeans reference grid
mVectorBg <- qdrg(object = mVectorBorneIntro, data = vecbordat)

mVectorBgem <- emmeans(mVectorBg, ~ Vector.borne|Global.Change.Driver)

#Only difference is in BC and IS
pairs((mVectorBgem))

```

```{r Vectorborne Figure, echo = FALSE}
datfig_VectB <- data.frame(mVectorBgem)
datfig_VectB$Global.Change.Driver <- as.factor(datfig_VectB$Global.Change.Driver)

datfig_VectB$Global.Change.Driver = factor(datfig_VectB$Global.Change.Driver,
                                          levels(datfig_VectB$Global.Change.Driver)[c(5,4,2,3,1)])

#make the plot
fig_vectB <- ggplot(datfig_VectB, aes(x = Global.Change.Driver, 
                 y=emmean,
                 shape = Vector.borne,
                 color = Global.Change.Driver)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  scale_color_manual(values = rev(c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2")),
                     name = "Global Change Driver",
                     guide = "none")+
  scale_shape_manual(values = c(16,17),
                     name = "Vector-borne")+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR() 

fig_vectB

# ggsave("./Figures/GCDFigSVB.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.61,
#        units = "in")

```

### Ecto- v. Endoparasites
No differences between ecto- and edo- parasites in response to biodiversity change, chemical pollution, and climate change. For Introduced Species, ecto-parasites respond  positively, while endo-parasites do not change. Conversely, for habitat loss, ecto-parasites respond negatively, while endo-parasites do not change.

```{r Ectoparasites}
##Number of replicates
nrow(ectodat)

mEctoparasite <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Ectoparasite + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=ectodat, method = "ML")
        
mEctoparasiteIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Ectoparasite * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=ectodat, method = "ML")
        

anova(mEctoparasite, mEctoparasiteIntML)

mEctoparasiteInt <- rma.mv(SMDH_yi, SMDH_viC,
                      mods = ~ Ectoparasite * Global.Change.Driver - 1,
                      random = list(~1|Citation.number, ~1|ind_id), data=ectodat)
        

mEctoparasiteIntro <- robust(mEctoparasiteInt, cluster=Citation.number, clubSandwich=TRUE)
mEctoparasiteIntro

##Set up emmeans reference grid
mEctoparasiteBg <- qdrg(object = mEctoparasiteIntro, data = ectodat)

mEctoparasiteBgem <- emmeans(mEctoparasiteBg, ~ Ectoparasite|Global.Change.Driver)

#Only difference is in IS
pairs((mEctoparasiteBgem))

```

```{r Ectoparasite Figure, echo  = FALSE}

datfig_Ecto <- data.frame(mEctoparasiteBgem)
datfig_Ecto$Global.Change.Driver = as.factor(datfig_Ecto$Global.Change.Driver)

datfig_Ecto$Global.Change.Driver = factor(datfig_Ecto$Global.Change.Driver,
                                          levels(datfig_Ecto$Global.Change.Driver)[c(5,4,2,3,1)])

#make the plot
fig_Ecto <- ggplot(datfig_Ecto, aes(x = Global.Change.Driver, 
                 y=emmean,
                 shape = Ectoparasite,
                 color = Global.Change.Driver)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  scale_color_manual(values = rev(c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2")),
                     name = "Global Change Driver",
                     guide = "none")+
  scale_shape_manual(values = c(16,17),
                     name = "Ectoparasite")+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()     
fig_Ecto
# ggsave("./Figures/GCDFigS7.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.61,
#        units = "in")


```

### Human v. Non-human Parasites
There are no differences in human v. non-human parasites in their response to global change drivers. 
```{r Human Parasites}
###### Human Parasites
##Number of replicates
nrow(humdat)

mHuman <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Human.Parasite + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=humdat, method = "ML")
        
mHumanInt <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Human.Parasite * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=humdat, method = "ML")
        

#Not significant
anova(mHuman, mHumanInt)

mHumanFin <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Human.Parasite + Global.Change.Driver - 1,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=humdat, method = "REML")
        

mHumanro <- robust(mHumanFin, cluster=Citation.number, clubSandwich=TRUE)
mHumanro

mHumang <- qdrg(object = mHumanro, data = humdat)

mHumangem <- emmeans(mHumang, ~ Human.Parasite)
pairs(mHumangem)

##P-value indicates non-significant difference between Human and non-human parasites
##human parasite effect size is 0.128 less than non-human (p = 0.1593)

```

### Venue
Lab studies tend to overestimate the effect of changes in biodiversity on disease. Conversely, Lab studies underestimate the effects of habitat loss and change disease. For all other GCDs tested (introduced species, climate change, and chemical pollution), lab studies were no different from field studies of these drivers on disease.

```{r Venue}
##Number of replicates
nrow(vendat)

mVenue <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Venue + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=vendat, method = "ML")
        
mVenueIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Venue * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=vendat, method = "ML")
        

#Very diff
anova(mVenue, mVenueIntML)

mVenueInt <- rma.mv(SMDH_yi, SMDH_viC,
                      mods = ~ Venue * Global.Change.Driver - 1,
                      random = list(~1|Citation.number, ~1|ind_id), data=vendat)
        

mVenueIntro <- robust(mVenueInt, cluster=Citation.number, clubSandwich=TRUE)
mVenueIntro

##Set up emmeans reference grid
mVenueg <- qdrg(object = mVenueIntro, data = vendat)

mVenuegem <- emmeans(mVenueg, ~ Venue|Global.Change.Driver)

#Only difference is in BC
pairs((mVenuegem))

```


```{r Venue Figure, echo = FALSE}
datfig_Venue  <- data.frame(mVenuegem)
datfig_Venue$Global.Change.Driver = as.factor(datfig_Venue$Global.Change.Driver)

datfig_Venue$Global.Change.Driver = factor(datfig_Venue$Global.Change.Driver,
                                          levels(datfig_Venue$Global.Change.Driver)[c(5,4,2,3,1)])

#make the plot
fig_venue <- ggplot(datfig_Venue, aes(x = Global.Change.Driver, 
                        y=emmean,
                        shape = Venue,
                        color = Global.Change.Driver)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  scale_color_manual(values = rev(c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2")),
                     name = "Global Change Driver",
                     guide = "none")+
  scale_shape_manual(values = c(16,17),
                     name = "Venue")+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()
fig_venue
# ggsave("./Figures/GCDFigS10.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")

```

### Habitat
There is a difference in how different habitats respond to biodiversity change. Specifically, effects of biodiversity change on disease is expected to be strongest in marine systems, followed by freshwater, with terrestrial systems responding relatively weakly. Additionally, in response to habitat loss/change, disease in marine and freshwater systems increases while disease in terrestrial systems decreases.

```{r Habitat}
##Number of replicates
nrow(habdat)

mHabitat <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Habitat + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=habdat, method = "ML")
        
mHabitatIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Habitat * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=habdat, method = "ML")
        

#Diff
anova(mHabitat, mHabitatIntML)

mHabitatInt <- rma.mv(SMDH_yi, SMDH_viC,
                      mods = ~ Habitat * Global.Change.Driver - 1,
                      random = list(~1|Citation.number, ~1|ind_id), data=habdat)
        

mHabitatIntro <- robust(mHabitatInt, cluster=Citation.number, clubSandwich=TRUE)
mHabitatIntro

##Set up emmeans reference grid
mHabitatg <- qdrg(object = mHabitatIntro, data = habdat)

mHabitatgem <- emmeans(mHabitatg, ~ Habitat | Global.Change.Driver)

#Only difference is in BC and HLC
pairs((mHabitatgem))
```

```{r, echo = FALSE}

figdat_Hab <- data.frame(mHabitatgem)
figdat_Hab$Global.Change.Driver = as.factor(figdat_Hab$Global.Change.Driver)

figdat_Hab$Global.Change.Driver = factor(figdat_Hab$Global.Change.Driver,
                                          levels(figdat_Hab$Global.Change.Driver)[c(5,4,2,3,1)])

fig_hab <- ggplot(figdat_Hab, aes(x = Global.Change.Driver, 
                        y=emmean,
                        shape = Habitat,
                        color = Global.Change.Driver)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  scale_color_manual(values = rev(c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2")),
                     guide = "none")+
  scale_shape_manual(values = c(16,17,18),
                     name = "Habitat")+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()
fig_hab
# ggsave("./Figures/GCDFigS11.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")
```

### Route
Route (complex or direct) was significantly different for biodiversity change and IS. Very similar patterns to the vector-borne status results, so likely very similar drivers there.

```{r Route}
##Number of replicates
nrow(datRoute)

mRoute <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Route + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datRoute, method = "ML")
mRouteIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Route * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datRoute, method = "ML")

#Difference
anova(mRoute, mRouteIntML)


mRouteIntro <- rma.mv(SMDH_yi, SMDH_viC,
                      mods = ~ Route * Global.Change.Driver - 1,
                      random = list(~1|Citation.number, ~1|ind_id), data=datRoute)

mRouteIntro <- robust(mRouteIntro, cluster=Citation.number, clubSandwich=TRUE)
mRouteIntro

##Set up emmeans reference grid
mRouteIntg <- qdrg(object = mRouteIntro, data = datRoute)

mRouteIntgem <- emmeans(mRouteIntg, ~ Route | Global.Change.Driver)

#Differences in BC and IS
pairs((mRouteIntgem))

```

```{r Route Figure, echo = FALSE}

datfig_Route  <- data.frame(mRouteIntgem)
datfig_Route$Global.Change.Driver = as.factor(datfig_Route$Global.Change.Driver)

datfig_Route$Global.Change.Driver = factor(datfig_Route$Global.Change.Driver,
                                          levels(datfig_Route$Global.Change.Driver)[c(5,4,2,3,1)])

#make the plot
fig_route <- ggplot(datfig_Route, aes(x = Global.Change.Driver, 
                        y=emmean,
                        shape = Route,
                        color = Global.Change.Driver)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  scale_color_manual(values = rev(c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2")),
                     guide = "none")+
  scale_shape_manual(values = c(16,17),
                     name = "Route")+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()
fig_route
# ggsave("./Figures/GCDFigSROUTE.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")

```

### Free Living Stages
There was no difference among different types of free living stages in their response to global change drivers.

```{r Free Living Stages}
##Number of replicates
nrow(datFLstage)

mStage <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Free.living.stages + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datFLstage, method = "ML")
          
mStageIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Free.living.stages * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datFLstage, method = "ML")
          

#No Difference
anova(mStage, mStageIntML)

anova(mStage, btt = 2)
##No difference between free-living and non-free living parasites

mStage <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Free.living.stages + Global.Change.Driver - 1,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datFLstage, method = "REML")
          
mStagero <- robust(mStage, cluster=Citation.number, clubSandwich=TRUE)
mStagero

mStageg <- qdrg(object = mStagero, data = datFLstage)

mStagegem <- emmeans(mStageg, ~ Free.living.stages)
mStagegem

```


### Macroparasites
Parasite size was different for biodiversity change (macroparasites responded more positively to biodiversity loss) and for Habitat Loss/Change (macroparasites responded more negatively to habitat loss/change).

```{r Macroparasites}
##Number of replicates
nrow(datMacroparasite)

mMacro <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Macroparasite + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datMacroparasite, method = "ML")
          
mMacroIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Macroparasite * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datMacroparasite, method = "ML")
          

#Difference
anova(mMacro, mMacroIntML)

mMacroInt <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Macroparasite * Global.Change.Driver - 1,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datMacroparasite)
          

mMacroIntro <- robust(mMacroInt, cluster=Citation.number, clubSandwich=TRUE)
mMacroIntro

##Set up emmeans reference grid
mMacroIntg <- qdrg(object = mMacroIntro, data = datMacroparasite)

mMacroIntgem <- emmeans(mMacroIntg, ~ Macroparasite | Global.Change.Driver)

#Differences in BC and HLC
pairs((mMacroIntgem))

```

```{r, echo = FALSE}
datfig_Macro  <- data.frame(mMacroIntgem)
datfig_Macro$Global.Change.Driver = as.factor(datfig_Macro$Global.Change.Driver)

datfig_Macro$Global.Change.Driver = factor(datfig_Macro$Global.Change.Driver,
                                          levels(datfig_Macro$Global.Change.Driver)[c(5,4,2,3,1)])

#make the plot
fig_macro <- ggplot(datfig_Macro, aes(x = Global.Change.Driver, 
                        y=emmean,
                        shape = Macroparasite,
                        color = Global.Change.Driver)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  scale_color_manual(values = rev(c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2")),
                     guide = "none")+
  scale_shape_manual(values = c(16,17),
                     name = "Macroparasite")+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()
fig_macro
# ggsave("./Figures/GCDFigSSize.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")

```

### Host Thermy
We see a slight difference in disease response between ecto- and endo- thermic hosts for biodiversity change and habitat loss/change. For biodiversity change, this suggests that changes in biodiversity will increase disease more in ectothermic hosts than in endothermic hosts. And for HLC, it suggests the opposite (disease decreasing in endothermic hosts more than ectothermic hosts).

```{r Thermy}
##Number of replicates
nrow(datHostThermy)

mThermy <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Ectothermic.host + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datHostThermy, method = "ML")
          
mThermyIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Ectothermic.host * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datHostThermy, method = "ML")
          

#Difference!
anova(mThermy, mThermyIntML)

mThermyInt <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Ectothermic.host * Global.Change.Driver-1,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datHostThermy)
          

mThermyIntro <- robust(mThermyInt, cluster=Citation.number, clubSandwich=TRUE)
mThermyIntro


##Set up emmeans reference grid
mThermyIntg <- qdrg(object = mThermyIntro, data = datHostThermy)

mThermyIntgem <- emmeans(mThermyIntg, ~ Ectothermic.host | Global.Change.Driver)

#Differences in BC and HLC
pairs((mThermyIntgem))
```

```{r Thermy Figure, echo = FALSE}
datfig_Thermy <- data.frame(mThermyIntgem)
datfig_Thermy$Global.Change.Driver = as.factor(datfig_Thermy$Global.Change.Driver)

datfig_Thermy$Global.Change.Driver = factor(datfig_Thermy$Global.Change.Driver,
                                          levels(datfig_Thermy$Global.Change.Driver)[c(5,4,2,3,1)])

#make the plot
fig_thermy <- ggplot(datfig_Thermy, aes(x = Global.Change.Driver, 
                        y=emmean,
                        shape = Ectothermic.host,
                        color = Global.Change.Driver)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  scale_color_manual(values = rev(c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2")),
                     guide = "none")+
  scale_shape_manual(values = c(16,17),
                     name = "Ectothermic Host")+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()
fig_thermy
# ggsave("./Figures/GCDFigS8.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")

```

### Zoonotic
We see no difference between of Zoonotic/non-zoonotic diseases either main or interactive effects.

```{r Zoonotic}
##Number of replicates
nrow(datZoonotic)

mZoo <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Zoonotic + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datZoonotic, method = "ML")
mZooIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Zoonotic * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datZoonotic, method = "ML")

#no difference
anova(mZoo, mZooIntML)

mZooInt <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Zoonotic + Global.Change.Driver-1,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=datZoonotic)

mZooIntro <- robust(mZooInt, cluster=Citation.number, clubSandwich=TRUE)
mZooIntro


##Set up emmeans reference grid
mZooIntg <- qdrg(object = mZooIntro, data = datZoonotic)

mZooIntgem <- emmeans(mZooIntg, ~ Zoonotic)

#Differences in BC and HLC
pairs((mZooIntgem))
```

```{r, echo = F, eval = F}
EDF8_WHOLE2 = cowplot::align_plots(endpointfig+theme(legend.position = c(0.775,0.325),
                                                   legend.title = element_text(size = 12),
                                                   legend.text = element_text(size = 12)),
                                   fig_vectB+theme(legend.position = c(0.8,0.5),
                                                   axis.title.y = element_blank(),
                                                  axis.text.y = element_blank(),
                                                   legend.title = element_text(size = 12),
                                                   legend.text = element_text(size = 12)),
                                  fig_route+theme(legend.position =c(0.8,0.5),
                                                  axis.title.y = element_blank(),
                                                  axis.text.y = element_blank(),
                                                   legend.title = element_text(size = 12),
                                                   legend.text = element_text(size = 12)),
                                  fig_macro+theme(legend.position =c(0.8,0.5),
                                                  axis.title.y = element_blank(),
                                                  axis.text.y = element_blank(),
                                                   legend.title = element_text(size = 12),
                                                   legend.text = element_text(size = 12)),
                                  fig_venue+theme(legend.position = c(0.8,0.5),
                                                   legend.title = element_text(size = 12),
                                                   legend.text = element_text(size = 12)),
                                  fig_hab+theme(legend.position = c(0.8,0.5),
                                                  axis.title.y = element_blank(),
                                                  axis.text.y = element_blank(),
                                                   legend.title = element_text(size = 12),
                                                   legend.text = element_text(size = 12)),
                                  fig_thermy+theme(legend.position = c(0.775,0.325),
                                                  axis.title.y = element_blank(),
                                                  axis.text.y = element_blank(),
                                                   legend.title = element_text(size = 12),
                                                   legend.text = element_text(size = 12)),
                                  fig_Ecto+theme(legend.position = c(0.8,0.5),
                                                  axis.title.y = element_blank(),
                                                  axis.text.y = element_blank(),
                                                   legend.title = element_text(size = 12),
                                                   legend.text = element_text(size = 12)))
                                  # align = 'hv', axis = 'l')

EDF8_fig2 = cowplot::plot_grid(EDF8_WHOLE2[[1]], 
                              EDF8_WHOLE2[[2]],
                              EDF8_WHOLE2[[3]], 
                              EDF8_WHOLE2[[4]],
                              EDF8_WHOLE2[[5]], 
                              EDF8_WHOLE2[[6]],
                              EDF8_WHOLE2[[7]], 
                              EDF8_WHOLE2[[8]], 
                              labels = c("A)","B)","C)","D)","E)","F)","G)","H)"),
                              ncol = 4,
                              rel_widths = c(1,0.85,0.85,0.85,
                                             1,0.85,0.85,0.85),
                              label_x = c(0.175,0.05,0.05,0.05,
                                          0.175,0.05,0.05,0.05),
                              label_y = 0.975)
EDF8_fig2


ggsave("./Figures/GCDEDF82.tiff", EDF8_fig2,
       dpi = 300,
       width = 7.5,
       height = 4,
       units = "in",
       scale = 2)

```



### Secondary analyses

#### Zoonotic diseases
For zoonotic diseases, whether the response of these diseases in humans and non-human animals to global change drivers is consistent (i.e., not significantly different) may provide clarity into emerging infectious diseases and pandemic risk. Here, we show no interaction between human and non-human endpoints and the global change drivers. But, there is a significant difference between human and non-human endpoints in their responses across global change drivers. Specifically, disease in non-humans responds more positively to global change drivers than disease in humans, such that the response disease in non-humans is consistently more positive (closer to zero if response of human disease is negative) than disease in humans.
```{r supp zoo}
zoodat1 <- fulldat2 %>%
  filter(Zoonotic == "Yes") 

nrow(zoodat1)
mZooHum <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ humanendpoint + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=zoodat1, method = "ML")
mZooHumIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ humanendpoint * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=zoodat1, method = "ML")

#no difference
anova(mZooHum, mZooHumIntML)

mZooHum <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ humanendpoint + Global.Change.Driver - 1,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=zoodat1, method = "REML")

mZooHumro <- robust(mZooHum, cluster=Citation.number, clubSandwich=TRUE)
mZooHumro


##Set up emmeans reference grid
mZooHumg <- qdrg(object = mZooHumro, data = zoodat1)

mZooHumgem <- emmeans(mZooHumg, ~ humanendpoint)

#Difference between human and non-human endpoints
pairs((mZooHumgem))


```


```{r sup zoo figure, echo = FALSE}
datfig_zoohum <- data.frame(emmeans(mZooHumg, ~ humanendpoint|Global.Change.Driver))
datfig_zoohum$Global.Change.Driver = as.factor(datfig_zoohum$Global.Change.Driver)

datfig_zoohum$Global.Change.Driver = factor(datfig_zoohum$Global.Change.Driver,
                                          levels(datfig_zoohum$Global.Change.Driver)[c(5,4,2,3,1)])

#make the plot
zoohumfig <- ggplot(datfig_zoohum, aes(x = Global.Change.Driver, 
                        y=emmean,
                        shape = humanendpoint,
                        color = Global.Change.Driver)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  scale_color_manual(values = rev(c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2")),
                     guide = "none")+
  scale_shape_manual(values = c(16,17),
                     name = "Human Endpoint")+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()

# ggsave("./Figures/GCDZooHNh.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")

```

#### Wild-life vs. domestic endpoints - animals only

```{r Wild v. domesticated animals}

wddat <- fulldat2 %>% filter(!is.na(domesticatedanimalendpoint))

nrow(wddat)
mwdanML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ domesticatedanimalendpoint + Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=wddat, method = "ML")
mwdanIntML <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ domesticatedanimalendpoint * Global.Change.Driver,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=wddat, method = "ML")

#no difference
anova(mwdanML, mwdanIntML)

mwda <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ domesticatedanimalendpoint + Global.Change.Driver - 1,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=wddat, method = "REML")

mwdaro <- robust(mwda, cluster=Citation.number, clubSandwich=TRUE)
mwdaro


##Set up emmeans reference grid
mwdag <- qdrg(object = mwdaro, data = wddat)

mwdagem <- emmeans(mwdag, ~ domesticatedanimalendpoint)

#Difference between wild and domesticated animal endpoints
pairs((mwdagem))

```

```{r sup animal figure, echo = FALSE}
datfig_wda <- data.frame(emmeans(mwdag, ~ domesticatedanimalendpoint|Global.Change.Driver))
datfig_wda$Global.Change.Driver = as.factor(datfig_wda$Global.Change.Driver)

datfig_wda$Global.Change.Driver = factor(datfig_wda$Global.Change.Driver,
                                          levels(datfig_wda$Global.Change.Driver)[c(5,4,2,3,1)])

#make the plot
fig_wda <- ggplot(datfig_wda, aes(x = Global.Change.Driver, 
                        y=emmean,
                        shape = domesticatedanimalendpoint,
                        color = Global.Change.Driver)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  scale_color_manual(values = rev(c("#5E976E",
                                "#58355E",
                                "#FFCA3A",
                                "#EC0B43",
                                "#63ADF2")),
                     guide = "none")+
  scale_shape_manual(values = c(16,17),
                     labels = c("Wild Animal",
                                "Domesticated"),
                     name = "")+
  xlab("Global Change Driver") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()

# ggsave("./Figures/GCDwdoma_supp.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")

```

#### HLC supplemental analyses
Within HLC, we are testing whether enemy types respond differently to urbanization. Additionally, we are testing whether the reference land-use (rural, peri-urban, natural, or urbanization gradient) for urbanization influences the magnitude/direction of the effect size. Finally, we are testing whether for deforestation and fragmentation, the treatment (e.g., agriculture vs. clearcut/regrowth for deforestation and fragmentation gradient or high/low fragmentation for forest fragmentation) influences the magnitude/direction of the effect size.


```{r Additional HLC analysis}
urbdat <- fulldat2 %>% filter(Effect == "Urbanization")


nrow(zoodat1)
mUrb <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Enemy.type - 1,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=urbdat, method = "REML")
mUrbro <- robust(mUrb, cluster=Citation.number, clubSandwich=TRUE)
mUrbro


##Set up emmeans reference grid
mUrbg <- qdrg(object = mUrbro, data = urbdat)

mUrbgem <- emmeans(mUrbg, ~ Enemy.type)

#Difference between human and non-human endpoints
pairs((mUrbgem))

emmeans:::cld.emmGrid(mUrbgem)


### reference condition

mUrb_c <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ Urb_control - 1,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=urbdat, method = "REML")
mUrb_cro <- robust(mUrb_c, cluster=Citation.number, clubSandwich=TRUE)
mUrb_cro


##Set up emmeans reference grid
mUrb_cg <- qdrg(object = mUrb_cro, data = urbdat)

mUrb_cem <- emmeans(mUrb_cg, ~ Urb_control)

#Difference between human and non-human endpoints
pairs((mUrb_cem))


##deforestation/fragmentation
#clearcut/natural is anything but agriculture; e.g., clearcut and let regrow, clearcut and open, clearcut and park, etc.
#gradient is size gradient, fragment is large/continuous forest patch to small patch
def_fragdat <- fulldat2 %>% filter(Effect %in% c("Deforestation", "Forest Fragmentation"))

mdeff <- rma.mv(SMDH_yi, SMDH_viC,
                  mods = ~ DefFrag_treat - 1,
                  random = list(~1|Citation.number, ~1|ind_id),
                  data=def_fragdat, method = "REML")
mdeffro <- robust(mdeff, cluster=Citation.number, clubSandwich=TRUE)
mdeffro


##Set up emmeans reference grid
mdeffg <- qdrg(object = mdeffro, data = def_fragdat)

mdeffgem <- emmeans(mdeffg, ~ DefFrag_treat)

#Difference between treatments within fragmentation, but not deforestation
contrast(mdeffgem, list(Def = c(-1,1,0,0),
                        Frag = c(0,0,-1,1)))

```

```{r make the plots}
datfig_urb <- data.frame(emmeans(mUrbg, ~ Enemy.type))

#make the plot
fig_urbe <- ggplot(datfig_urb, aes(x = Enemy.type, 
                        y=emmean,
                        color = Enemy.type)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  # scale_shape_manual(values = c(16,17),
  #                    name = "Human Endpoint")+
  xlab("Enemy taxa") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()+
  theme(legend.position = 'none')

# ggsave("./Figures/GCDurbanenemy.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")


datfig_urbc <- data.frame(emmeans(mUrb_cg, ~ Urb_control))
levels(datfig_urbc$Urb_control)[1] = "Urban Gradient"

#make the plot
fig_urbc <- ggplot(datfig_urbc, aes(x = Urb_control, 
                        y=emmean,
                        color = Urb_control)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  # scale_shape_manual(values = c(16,17),
  #                    name = "Human Endpoint")+
  xlab("Urbanization reference land-use") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()+
  theme(legend.position = 'none')

# ggsave("./Figures/GCDfigurban.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")

datfig_deffc <- data.frame(emmeans(mdeffg, ~ DefFrag_treat))
levels(datfig_deffc$DefFrag_treat)[3] = "High/Low Fragmentation"
levels(datfig_deffc$DefFrag_treat)[4] = "Continuous Gradient"
#make the plot
fig_deffc <- ggplot(datfig_deffc, aes(x = DefFrag_treat, 
                        y=emmean,
                        color = DefFrag_treat)) +            #subtract 2 to adjust range of response
  geom_point(position = position_dodge(width = 0.2),
             size = 2.5) +                               #plot points
  geom_errorbar(aes(ymin = asymp.LCL,        #include error bars
                    ymax = asymp.UCL),     
                width=0.25,
                position = position_dodge(width = 0.2)) +                   #adjust width of bar
  # scale_y_continuous(limits = c(0,1.05),      #change limits of Y axis
  #                    breaks = c(0,0.5,1))+      #set Y axis breaks 
  geom_hline(yintercept = 0,                   #make a reference line at 0
             linetype = "dashed", 
             color = "black", 
             size = 1) +
  geom_vline(xintercept = 2.5,                   #make a reference line at 0
             linetype = "solid", 
             color = "black") +
  # scale_shape_manual(values = c(16,17),
  #                    name = "Human Endpoint")+
  xlab("Treatment land-use") +               #relabel X and Y axes
  ylab("Hedge's G") +
  coord_flip()+
  theme_JR()+
  theme(legend.position = 'none')

# ggsave("./Figures/GCDDefFrag_treat.tiff",
#        dpi = 300,
#        width = 6.5,
#        height = 4.65,
#        units = "in")

```

```{r supplemental analysis figure, eval = F, echo = F}
##generate the figure for all of the supplemental analyses



fig_wda, zoohumfig

EDF9_WHOLE = cowplot::align_plots(zoohumfig+theme(legend.position = c(0.775,0.325),
                                                   legend.title = element_text(size = 12),
                                                   legend.text = element_text(size = 12)),
                                  fig_wda+theme(legend.position = c(0.775,0.325),
                                                   axis.title.y = element_blank(),
                                                  axis.text.y = element_blank(),
                                                   legend.title = element_text(size = 12),
                                                   legend.text = element_text(size = 12)))
                                  # align = 'hv', axis = 'l')

EDF9_fig = cowplot::plot_grid(EDF9_WHOLE[[1]], 
                              EDF9_WHOLE[[2]],
                              labels = c("A)","B)"),
                              ncol = 2,
                              rel_widths = c(1,0.85),
                              label_x = c(0.175,0.05),
                              label_y = 0.975)
EDF9_fig

ggsave("./Figures/GCDEDF9.tiff", EDF9_fig,
       dpi = 300,
       width = 4.5,
       height = 2,
       units = "in",
       scale = 2)

EDF10_WHOLE = cowplot::align_plots(fig_urbe,
                                   fig_urbc,
                                  fig_deffc,
                                  align = "hv")
EDF10_fig = cowplot::plot_grid(EDF10_WHOLE[[1]], 
                              EDF10_WHOLE[[2]],
                              EDF10_WHOLE[[3]],
                              labels = c("A)","B)","C)"),
                              ncol = 1,
                              rel_widths = c(1,1,1),
                              label_x = c(0.175,0.175,0.175),
                              label_y = 1)

ggsave("./Figures/GCDEDF10.tiff", EDF10_fig,
       dpi = 300,
       width = 3,
       height = 6,
       units = "in",
       scale = 2)



```

## Step 4: Model Selection:
### What factors best explain disease response to specific global change drivers?
* Model selection process for each individual GCD
* Only using citation here to stay within the bounds of the meta-analysis framework

#### Data prep
* For each individual global change driver, removed all NA values for predictors.
*Cchecked for missing cells (i.e. Marine habitats and Habitat Loss).
* As such, replicates for each GCD are below.

```{r Model selection prep}

##Remove all rows with NA values in ANY of the categories
dataBL2 = fulldat2 %>%
  filter(Global.Change.Driver == "BC" &
           complete.cases(Habitat) &
           complete.cases(Enemy.type) &
           complete.cases(Vector.borne) &
           complete.cases(Free.living.stages) &
           complete.cases(Effect) &
           Native.host.type != "Fish")

##Replicates for biodiversity (387)
nrow(dataBL2)

##Climate change
##Remove all rows with NA values in ANY of the categories
dataCC2 = fulldat2 %>%
  filter(Global.Change.Driver == "CC" &
           complete.cases(Habitat) &
           complete.cases(Enemy.type) &
           complete.cases(Vector.borne) &
           complete.cases(Native.host.type) & 
           complete.cases(Ectoparasite) &
           complete.cases(Ectothermic.host) &
           complete.cases(Venue) &
           complete.cases(Free.living.stages) &
           complete.cases(Route) &           
           complete.cases(Zoonotic) &
           complete.cases(Human.Parasite) &
           complete.cases(Macroparasite) &
           complete.cases(Effect) &
           complete.cases(Endpoint_Host_Parasite) &
           complete.cases(SMDH_yi) &
           complete.cases(SMDH_viC))

##Replicates for climate change (302)
nrow(dataCC2)

#Habitat Loss/Change
##Remove all rows with NA values in ANY of the categories
dataHLC2 = fulldat2 %>%
  filter(Global.Change.Driver == "HLC",
         complete.cases(Habitat) &
           complete.cases(Enemy.type) &
           complete.cases(Vector.borne) &
           complete.cases(Native.host.type) & 
           complete.cases(Ectoparasite) &
           complete.cases(Free.living.stages) &
           complete.cases(Endpoint_Host_Parasite) &
           complete.cases(Route) &
           complete.cases(Human.Parasite) &
           complete.cases(Macroparasite) &
           complete.cases(Zoonotic) &
           complete.cases(Venue) &
           complete.cases(Effect) &
           complete.cases(Ectothermic.host) &
           complete.cases(SMDH_yi) &
           complete.cases(SMDH_viC))
dataHLC2 %>%
  group_by(Habitat) %>%
  summarize(count = n())

dataHLC2 = subset(dataHLC2, 
                    Habitat != "Marine")


##Replicates for habitat loss/change (1268)
nrow(dataHLC2)

##Introduced species
##Remove all rows with NA values in ANY of the categories
dataIS2 = fulldat2 %>%
  filter(Global.Change.Driver == "IS" & 
           complete.cases(Habitat) &
           complete.cases(Enemy.type) &
           complete.cases(Vector.borne) &
           complete.cases(Native.host.type) & 
           complete.cases(Ectoparasite) &
           complete.cases(Free.living.stages) &
           complete.cases(Endpoint_Host_Parasite) &
           complete.cases(Route) &
           complete.cases(Human.Parasite) &
           complete.cases(Macroparasite) &
           complete.cases(Zoonotic) &
           complete.cases(Venue) &
           complete.cases(Effect) &
           complete.cases(Ectothermic.host) &
           complete.cases(SMDH_yi) &
           complete.cases(SMDH_viC))

##Replicates for introduced species (309)
nrow(dataIS2)

##Chemical pollution
##Remove all rows with NA values in ANY of the categories
dataCP2 = fulldat2 %>%
  filter(Global.Change.Driver == "CP" &
         complete.cases(Habitat) &
           complete.cases(Enemy.type) &
           complete.cases(Vector.borne) &
           complete.cases(Native.host.type) & 
           complete.cases(Ectoparasite) &
           complete.cases(Free.living.stages) &
           complete.cases(Endpoint_Host_Parasite) &
           complete.cases(Route) &
           complete.cases(Human.Parasite) &
           complete.cases(Macroparasite) &
           complete.cases(Zoonotic) &
           complete.cases(Venue) &
           complete.cases(Effect) &
           complete.cases(Ectothermic.host) &
           complete.cases(SMDH_yi) &
           complete.cases(SMDH_viC))

##Replicates for chemical pollution (342)
nrow(dataCP2)
```

#### Data Analysis
* Model selection output is for $\Delta$ AIC < 2.
* Best models are AICc indicated best models, not including parsimony in best model.

```{r}

##rma() wrapper for dredge
makeArgs.rma <- function(obj, termNames, comb, opt, 
                         ...) {
  ret <- MuMIn:::makeArgs.default(obj, termNames, comb, opt)
  names(ret)[1L] <- "mods"
  ret
}

##rma() wrapper for dredge
coefTable.rma <- function(model, ...) {
  MuMIn:::.makeCoefTable(model$b, model$se, coefNames = rownames(model$b))
}


```


### Biodiversity Change

```{r Biodiversity Change, echo = FALSE,  warning = FALSE}
##Do this once
options(na.action = "na.fail")

# BioDiv_Whole <- rma.mv(SMDH_yi, SMDH_viC,
#                        mods = ~ Effect +
#                          Endpoint_Host_Parasite +
#                          Native.host.type +
#                          Enemy.type +
#                          Ectoparasite + Vector.borne + Free.living.stages +
#                          Route + Human.Parasite +
#                          Macroparasite + Zoonotic +
#                          Venue + Habitat + Ectothermic.host,
#                        random = list(~1|Citation.number, ~1|ind_id),
#                        data = dataBL2, method = "ML")
# 
# BioDiv_Dredge = dredge(BioDiv_Whole)
# saveRDS(BioDiv_Dredge, "./Data/BioDiv_Dredge.RDS")
BioDiv_Dredge <- readRDS("./Data/BioDiv_Dredge.RDS")


summary(model.avg(BioDiv_Dredge, delta < 2))
sw(subset(BioDiv_Dredge, delta < 4))

```

### Climate Change
Cannot have "Enemy.type_further_reduced_Final" and "MacroparasiteBoth.NA" in the model; not uniquely determined. So, dropped "macroparasite".

```{r Climate Change, echo = FALSE,  warning = FALSE}
# ClimChange_Whole <- rma.mv(SMDH_yi, SMDH_viC,
#                        mods = ~ Effect +
#                          Endpoint_Host_Parasite +
#                          Native.host.type +
#                          Enemy.type +
#                          Ectoparasite + Vector.borne + Free.living.stages +
#                          Route + Human.Parasite +
#                          Macroparasite + Zoonotic +
#                          Venue + Habitat + Ectothermic.host,
#                        random = list(~1|Citation.number, ~1|ind_id),
#                        data = dataCC2, method = "ML")
# 
# ClimChange_Dredge = dredge(ClimChange_Whole)
# saveRDS(ClimChange_Dredge, "./Data/ClimChange_Dredge.RDS")
ClimChange_Dredge <- readRDS("./Data/ClimChange_Dredge.RDS")

summary(model.avg(ClimChange_Dredge, delta < 2))
sw(subset(ClimChange_Dredge, delta < 4))

```

### Habitat Loss and Change


```{r Habitat Loss/Change, echo = FALSE,  warning = FALSE}
# HabLoss_Whole <- rma.mv(SMDH_yi, SMDH_viC,
#                        mods = ~ Effect +
#                          Endpoint_Host_Parasite +
#                          Native.host.type +
#                          Enemy.type +
#                          Ectoparasite + Vector.borne + Free.living.stages +
#                          Route + Human.Parasite +
#                          Macroparasite + Zoonotic +
#                          Venue + Habitat + Ectothermic.host,
#                        random = list(~1|Citation.number, ~1|ind_id),
#                        data = dataHLC2, method = "ML")
#   
#   
# HabLoss_Dredge = dredge(HabLoss_Whole, trace = 2)
# saveRDS(HabLoss_Dredge, "./Data/HabLoss_Dredge.RDS")

HabLoss_Dredge <- readRDS("./Data/HabLoss_Dredge.RDS")

summary(model.avg(HabLoss_Dredge, delta < 2))
sw(subset(HabLoss_Dredge, delta < 4))

```

### Introduced Species

```{r Introduced Species, echo = FALSE,  warning = FALSE}

# IntroSpec_Whole <- rma.mv(SMDH_yi, SMDH_viC,
#                        mods = ~ Effect +
#                          Endpoint_Host_Parasite +
#                          Native.host.type +
#                          Enemy.type +
#                          Ectoparasite + Vector.borne + Free.living.stages +
#                          Route + Human.Parasite +
#                          Macroparasite + Zoonotic +
#                          Venue + Habitat + Ectothermic.host,
#                        random = list(~1|Citation.number, ~1|ind_id),
#                        data = dataIS2, method = "ML")
#   
# IntroSpec_Dredge = dredge(IntroSpec_Whole)
# saveRDS(IntroSpec_Dredge, "./Data/IntroSpec_Dredge.RDS")

IntroSpec_Dredge <- readRDS("./Data/IntroSpec_Dredge.RDS")


summary(model.avg(IntroSpec_Dredge, delta < 2))
sw(subset(IntroSpec_Dredge, delta < 4))

```

### Chemical Pollution

```{r Chemical Pollution, echo = FALSE, warning = FALSE}
# ChemPoll_Whole <- rma.mv(SMDH_yi, SMDH_viC,
#                        mods = ~ Effect +
#                          Endpoint_Host_Parasite +
#                          Native.host.type +
#                          Enemy.type +
#                          Ectoparasite + Vector.borne + Free.living.stages +
#                          Route + Human.Parasite +
#                          Macroparasite + Zoonotic +
#                          Venue + Habitat + Ectothermic.host,
#                        random = list(~1|Citation.number, ~1|ind_id),
#                        data = dataCP2, method = "ML")
# 
# ChemPoll_Dredge = dredge(ChemPoll_Whole)
# saveRDS(ChemPoll_Dredge, "./Data/ChemPoll_Dredge.RDS")

ChemPoll_Dredge <- readRDS("./Data/ChemPoll_Dredge.RDS")


summary(model.avg(ChemPoll_Dredge, delta < 2))
sw(subset(ChemPoll_Dredge, delta < 4))

```

```{r single Importplot, echo = FALSE, warning = FALSE}
#BRING ALL OF THE IMPORTANCE SCORE FIGURES TOGETHER IN 1

biodivimport = data.frame(
  Variable = attr(sw(subset(BioDiv_Dredge, delta < 4)), "names"),
  Importance = c(sw(subset(BioDiv_Dredge, delta < 4))),
  Nmodel = attr(sw(subset(BioDiv_Dredge, delta < 4)), "n.models")
  )

biodivimport$Variable = c("Habitat",
                          "Host type",
                          "Endpoint",
                          "Venue",
                          "Zoonotic",
                          "GCD subfactor",
                          "Parasite size",
                          "Transmission route",
                          "Host thermy",
                          "Vector-borne",
                          "Free living stages",
                          "Parasite type",
                          "Human Parasite"
)

biodivimport$Variable = forcats::fct_reorder(biodivimport$Variable, biodivimport$Importance, .desc = FALSE)
levels(biodivimport$Variable) = rev(as.character(forcats::fct_reorder(biodivimport$Variable, biodivimport$Importance, .desc = FALSE)))

importplot_bd = ggplot(biodivimport, aes(x = Variable, y = Importance))+
  geom_segment( aes(x=Variable, xend=Variable, y=0, yend=Importance),
                color="#5E976E") +
  geom_point( size=5, color="#5E976E", shape = 21, fill = "#5E976E") +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 1.05))+
  # annotate("text", x=1.6, y=0.85, label=bdlb1, parse=TRUE)+
  # annotate("text", x=1, y=0.85, label=bdlb2, parse=TRUE)+
  ylab("Importance Score")+
  coord_flip()+
  theme_JR()+
  theme(axis.title.y = element_blank(),
        # panel.grid.major.x = element_line(color = "light grey"),
        axis.text.y = element_text(size = 12))


climchangeimport = data.frame(
  Variable = attr(sw(subset(ClimChange_Dredge, delta < 4)), "names"),
  Importance = c(sw(subset(ClimChange_Dredge, delta < 4))),
  Nmodel = attr(sw(subset(ClimChange_Dredge, delta < 4)), "n.models"))
      

climchangeimport$Variable = c("Free living stages",
                              "Host thermy",
                              "Endpoint",
                              "Human Parasite",
                              "Venue",
                              "Parasite size",                              
                              "Vector-borne",
                              "Parasite type",
                              "Zoonotic",
                              "Transmission route",
                              "Enemy type",
                              "Habitat"
)


climchangeimport$Variable = forcats::fct_reorder(climchangeimport$Variable, climchangeimport$Importance, .desc = FALSE)
levels(climchangeimport$Variable) = rev(as.character(forcats::fct_reorder(climchangeimport$Variable, climchangeimport$Importance, .desc = FALSE)))

importplot_cc = ggplot(climchangeimport, aes(x = Variable, y = Importance))+
  geom_segment( aes(x=Variable, xend=Variable, y=0, yend=Importance),
                color="#FFCA3A") +
  geom_point( size=5, color="#FFCA3A", shape = 21, fill = "#FFCA3A") +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 1.05))+
  # annotate("text", x=1.6, y=0.85, label=cclb1, parse=TRUE)+
  # annotate("text", x=1, y=0.85, label=cclb2, parse=TRUE)+
  ylab("Importance Score")+
  coord_flip()+
  theme_JR()+
  theme(axis.title.y = element_blank(),
        # panel.grid.major.x = element_line(color = "light grey"),
        axis.text.y = element_text(size = 12))

hablossimport = data.frame(
  Variable = attr(sw(subset(HabLoss_Dredge, delta < 4)), "names"),
  Importance = c(sw(subset(HabLoss_Dredge, delta < 4))),
  Nmodel = attr(sw(subset(HabLoss_Dredge, delta < 4)), "n.models"))
      

hablossimport$Variable = c("Enemy type",
                           "Habitat",
                           "Parasite type",
                           "Host type",
                           "Host thermy",
                           "Zoonotic",
                           "Human Parasite",
                           "Parasite size",
                           "GCD subfactor",
                           "Transmission route",
                           "Venue",
                           "Vector-borne",
                           "Endpoint",
                           "Free living stages"
)

hablossimport$Variable = forcats::fct_reorder(hablossimport$Variable, hablossimport$Importance, .desc = FALSE)
levels(hablossimport$Variable) = rev(as.character(forcats::fct_reorder(hablossimport$Variable, hablossimport$Importance, .desc = FALSE)))

importplot_hl = ggplot(hablossimport, aes(x = Variable, y = Importance))+
  geom_segment( aes(x=Variable, xend=Variable, y=0, yend=Importance),
                color="#EC0B43") +
  geom_point( size=5, color="#EC0B43", shape = 21, fill = "#EC0B43") +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 1.05))+
  ylab("Importance Score")+
  coord_flip()+
  theme_JR()+
  theme(axis.title.y = element_blank(),
        # panel.grid.major.x = element_line(color = "light grey"),
        axis.text.y = element_text(size = 12))

inspimport = data.frame(
  Variable = attr(sw(subset(IntroSpec_Dredge, delta < 4)), "names"),
  Importance = c(sw(subset(IntroSpec_Dredge, delta < 4))),
  Nmodel = attr(sw(subset(IntroSpec_Dredge, delta < 4)), "n.models"))
      

inspimport$Variable = c("Habitat",
                        "Parasite size",
                        "Host type",
                        "Free living stages",
                        "Zoonotic",
                        "Parasite type",
                        "Venue",
                        "GCD subfactor",
                        "Host thermy",
                        "Human Parasite",
                        "Vector-borne",
                        "Transmission route",
                        "Endpoint",
                        "Enemy type"
)

inspimport$Variable = forcats::fct_reorder(inspimport$Variable, inspimport$Importance, .desc = FALSE)
levels(inspimport$Variable) = rev(as.character(forcats::fct_reorder(inspimport$Variable, inspimport$Importance, .desc = FALSE)))

importplot_is = ggplot(inspimport, aes(x = Variable, y = Importance))+
  geom_segment( aes(x=Variable, xend=Variable, y=0, yend=Importance),
                color="#63ADF2") +
  geom_point( size=5, color="#63ADF2", shape = 21, fill = "#63ADF2") +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 1.05))+
  ylab("Importance Score")+
  coord_flip()+
  theme_JR()+
  theme(axis.title.y = element_blank(),
        # panel.grid.major.x = element_line(color = "light grey"),
        axis.text.y = element_text(size = 12))

chempollimport = data.frame(
  Variable = attr(sw(subset(ChemPoll_Dredge, delta < 4)), "names"),
  Importance = c(sw(subset(ChemPoll_Dredge, delta < 4))),
  Nmodel = attr(sw(subset(ChemPoll_Dredge, delta < 4)), "n.models"))
      

chempollimport$Variable = c("Free living stages",
                            "Vector-borne",
                            "Parasite type",
                            "Transmission route",
                            "Venue",
                            "Human Parasite",
                            "Host thermy",
                            "Zoonotic",
                            "Parasite size",
                            "Endpoint",
                            "Habitat",
                            "Host type"
)


chempollimport$Variable = forcats::fct_reorder(chempollimport$Variable, chempollimport$Importance, .desc = FALSE)
levels(chempollimport$Variable) = rev(as.character(forcats::fct_reorder(chempollimport$Variable, chempollimport$Importance, .desc = FALSE)))

importplot_cp = ggplot(chempollimport, aes(x = Variable, y = Importance))+
  geom_segment( aes(x=Variable, xend=Variable, y=0, yend=Importance),
                color="#58355E") +
  geom_point( size=5, color="#58355E", shape = 21, fill = "#58355E") +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0, 1.05))+
  ylab("Importance Score")+
  coord_flip()+
  theme_JR()+
  theme(axis.title.y = element_blank(),
        # panel.grid.major.x = element_line(color = "light grey"),
        axis.text.y = element_text(size = 12))

import_whole = cowplot::align_plots(importplot_bd, importplot_cp,
                                    importplot_cc, importplot_hl,
                                    importplot_is,
                                    align = 'hv', axis = 'l')

importplotplot <- cowplot::plot_grid(import_whole[[1]], import_whole[[2]], import_whole[[3]],
                                  import_whole[[4]], import_whole[[5]],
                                  labels = c("A)","B)","C)","D)","E)"),
                                  ncol = 2,
                                  label_x = 0.9,
                                  label_y = 0.275)
importplotplot

ggsave("./Figures/ImportancePlotsGCD.tiff",importplotplot,
       dpi = 300,
       width = 4.75, ##Need to update this..
       height = 4.75,
       units = "in", scale = 2)


```
